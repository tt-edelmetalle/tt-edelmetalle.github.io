<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metallindex | Händlerpreise & Portfolio</title>
    <meta name="description" content="Aktuelle Händlerpreise für Gold, Silber, Platin und Palladium. Portfolio-Management." />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --------------------------------------------------
           DESIGN SYSTEM: Compact, trustful, responsive
           -------------------------------------------------- */
        :root {
            --c-primary: #c5a059;
            --c-primary-dark: #a38234;
            --c-bg-app: #0b1120;
            --c-bg-card: #121824;
            --c-text-main: #f1f5f9;
            --c-text-muted: #9aa7bb;
            --c-border: #24313f;
            --c-success: #10b981;
            --c-danger: #ef4444;
            --color-gold: #c5a059;
            --color-silver: #cbd5e1;
            --color-plat: #e2e8f0;
            --color-pall: #a8a29e;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --font-stack: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
            --nav-height: 72px;
            --glass: rgba(255,255,255,0.03);
            --card-elev: 18px;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-stack);
            background: linear-gradient(180deg,#070912 0%,var(--c-bg-app) 100%);
            color: var(--c-text-main);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }

        /* Container + grid */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 16px
        }

        .grid-dashboard {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr
        }

        @media(min-width:1024px) {
            .grid-dashboard {
                grid-template-columns: 320px 1fr
            }
        }

        /* NAV */
        .navbar {
            position: sticky;
            top: 0;
            z-index: 120;
            height: var(--nav-height);
            display: flex;
            align-items: center;
            backdrop-filter: blur(8px);
            background: linear-gradient(180deg, rgba(11,17,32,0.95), rgba(11,17,32,0.8));
            border-bottom: 1px solid var(--c-border);
            padding: 0 8px;
        }

        .nav-inner {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }

        .brand-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 1.15rem
        }

            .brand-logo span {
                color: var(--c-primary)
            }

        .nav-menu {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: 10px;
            color: var(--c-text-muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 160ms ease
        }

            .nav-item:hover {
                color: var(--c-text-main);
                background: var(--glass)
            }

            .nav-item.active {
                background: linear-gradient(90deg,var(--c-primary),var(--c-primary-dark));
                color: #000
            }

        #hamburger {
            display: none
        }

        @media(max-width:900px) {
            .nav-menu {
                display: none
            }

            #hamburger {
                display: inline-flex
            }
        }

        /* MOBILE NAV DRAWER (improved) */
        #mobile-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 140;
            opacity: 0;
            transition: opacity 220ms ease;
            pointer-events: none;
        }

            #mobile-overlay.active {
                display: block;
                opacity: 1;
                pointer-events: auto;
            }

        #mobile-nav {
            position: fixed;
            top: var(--nav-height);
            left: 0;
            bottom: 0;
            width: 80vw;
            max-width: 320px;
            transform: translateX(-120%);
            background: var(--c-bg-card);
            border-right: 1px solid var(--c-border);
            padding: 12px;
            z-index: 150;
            transition: transform 280ms cubic-bezier(.2,.9,.2,1);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 6px 0 30px rgba(2,6,23,0.5);
        }

            #mobile-nav.open {
                transform: translateX(0);
            }

            #mobile-nav .nav-item {
                display: block;
                margin-bottom: 8px
            }

        /* prevent background scroll when menu open */
        .no-scroll {
            overflow: hidden;
        }

        /* CARDS */
        .card {
            background: var(--c-bg-card);
            border: 1px solid var(--c-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 8px 30px rgba(2,6,23,0.6);
            transition: transform 220ms cubic-bezier(.2,.9,.2,1), box-shadow 220ms
        }

            .card:hover {
                transform: translateY(-4px);
                box-shadow: 0 18px 45px rgba(2,6,23,0.7)
            }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.03)
        }

        .card-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--c-text-main);
            display: flex;
            align-items: center;
            gap: 8px
        }

            .card-title i {
                color: var(--c-primary)
            }

        /* inputs */
        .form-control {
            width: 100%;
            background: transparent;
            border: 1px solid var(--c-border);
            color: var(--c-text-main);
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.95rem
        }

            .form-control:focus {
                outline: none;
                border-color: var(--c-primary);
                box-shadow: 0 6px 20px rgba(165,130,52,0.12)
            }

        .input-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            color: var(--c-text-muted);
            margin-bottom: 6px;
            display: block
        }

        /* custom select (replaces native popup) */
        .select-wrapper {
            position: relative;
        }

        .select-toggle {
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--c-border);
            color: var(--c-text-main);
            cursor: pointer
        }

            .select-toggle:focus {
                outline: none;
                box-shadow: 0 6px 20px rgba(165,130,52,0.12);
            }

        .custom-select-list {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 8px);
            background: var(--c-bg-card);
            border: 1px solid var(--c-border);
            border-radius: 8px;
            max-height: 260px;
            overflow-y: auto;
            z-index: 220;
            padding: 6px;
            box-shadow: 0 10px 30px rgba(2,6,23,0.6)
        }

            .custom-select-list li {
                list-style: none;
                padding: 10px 12px;
                border-radius: 6px;
                cursor: pointer;
                color: var(--c-text-main);
                background: transparent;
            }

                .custom-select-list li:hover, .custom-select-list li[aria-selected="true"] {
                    background: var(--glass);
                    color: var(--c-text-main)
                }

        .visually-hidden {
            position: absolute !important;
            height: 1px;
            width: 1px;
            overflow: hidden;
            clip: rect(1px,1px,1px,1px);
            white-space: nowrap
        }

        /* buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 180ms ease;
            border: 1px solid transparent
        }

            .btn:active {
                transform: translateY(1px)
            }

        .btn-primary {
            background: linear-gradient(135deg,var(--c-primary),var(--c-primary-dark));
            color: #000
        }

        .btn-outline {
            background: transparent;
            border-color: var(--c-border);
            color: var(--c-text-muted)
        }

            .btn-outline.active {
                border-color: var(--c-primary);
                color: var(--c-primary)
            }

        .btn-sm {
            padding: 8px 10px;
            font-size: 0.85rem
        }

        /* Prices */
        .big-price {
            font-size: clamp(1.25rem,2.3vw,2rem);
            font-weight: 800;
            color: var(--c-primary)
        }

        .sub-price {
            font-size: 0.85rem;
            color: var(--c-text-muted)
        }

        .source-badge {
            font-size: 0.78rem;
            background: rgba(255,255,255,0.02);
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--c-text-muted);
            border: 1px solid var(--c-border)
        }

        /* inventory */
        .inventory-list {
            margin-top: 6px;
            border-radius: 8px;
            overflow: hidden
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            gap: 14px;
            border-bottom: 1px solid var(--c-border);
            background: linear-gradient(180deg, transparent, rgba(0,0,0,0.02));
            transition: transform 300ms ease, opacity 260ms
        }

            .inventory-item:last-child {
                border-bottom: none
            }

        /* animations */
        @keyframes popIn {
            0% {
                transform: scale(0.96);
                opacity: 0
            }

            60% {
                transform: scale(1.02);
                opacity: 1
            }

            100% {
                transform: scale(1);
            }
        }

        .item-added {
            animation: popIn 360ms cubic-bezier(.2,.9,.2,1)
        }

        .fade-in {
            animation: fadeIn 420ms ease
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px)
            }

            to {
                opacity: 1;
                transform: none
            }
        }

        /* responsive adjustments */
        @media(max-width:768px) {
            .container {
                padding: 0 12px
            }

            .card {
                padding: 14px
            }

            .big-price {
                font-size: 1.3rem
            }

            .tradingview-widget-container {
                height: 220px !important
            }

            .brand-logo {
                font-size: 1rem
            }

            .navbar {
                height: 64px
            }

            #mobile-nav {
                top: 64px
            }

            .custom-select-list {
                max-height: 40vh
            }
        }

        .tradingview-widget-container {
            width: 100%;
            height: 100%;
            min-height: 180px
        }

        footer {
            background: var(--c-bg-card);
            border-top: 1px solid var(--c-border);
            padding: 28px 0;
            text-align: center;
            color: var(--c-text-muted);
            font-size: 0.88rem
        }

        .btn:focus, .form-control:focus, .nav-item:focus {
            outline: 3px solid rgba(197,160,89,0.12);
            outline-offset: 2px
        }

        .text-muted {
            color: var(--c-text-muted)
        }

        .grid-2 {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr
        }

        /* -------------------------
           Darken native select dropdowns
           (best-effort; some OS/browsers keep native UI)
           ------------------------- */
        select.form-control {
            background: var(--c-bg-card);
            color: var(--c-text-main);
            -webkit-appearance: none;
            appearance: none;
            border: 1px solid var(--c-border);
            padding-right: 28px; /* space for custom caret if desired */
        }

            select.form-control option {
                background: var(--c-bg-card);
                color: var(--c-text-main);
            }
            /* hide default IE/Edge arrow */
            select.form-control::-ms-expand {
                display: none;
            }

        /* add a subtle caret for selects inside containers */
        .select-inline {
            position: relative;
        }

            .select-inline:after {
                content: "\f0d7";
                font-family: "Font Awesome 6 Free";
                font-weight: 900;
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                pointer-events: none;
                color: var(--c-text-muted);
            }
    </style>
</head>
<body>

    <div id="main-app" style="display:block;">

        <nav class="navbar" role="navigation" aria-label="Hauptnavigation">
            <div class="nav-inner">
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="brand-logo" onclick="switchView('dashboard')" title="Zur Startseite">
                        <i class="fa-solid fa-layer-group"></i>
                        <span>Metall</span>index
                    </div>

                    <button id="hamburger" class="btn btn-outline" onclick="toggleMobileNav()" aria-expanded="false" aria-controls="mobile-nav"><i class="fa-solid fa-bars"></i></button>
                </div>

                <div class="nav-menu" id="navMenu">
                    <div class="nav-item active" id="nav-dash" onclick="switchView('dashboard')" tabindex="0">Marktübersicht</div>
                    <div class="nav-item" id="nav-calc" onclick="switchView('calculator')" tabindex="0">Portfolio Rechner</div>
                    <div class="nav-item" id="nav-ana" onclick="switchView('analysis')" tabindex="0">Research</div>
                </div>

                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.82rem; color:var(--c-text-muted);">Basis: EUR</span>
                </div>
            </div>
        </nav>

        <!-- overlay + mobile drawer moved outside the nav to avoid stacking issues -->
        <div id="mobile-overlay" tabindex="-1" aria-hidden="true"></div>
        <div id="mobile-nav" aria-hidden="true"></div>

        <div style="height:46px; background:transparent; border-bottom:1px solid var(--c-border);">
            <div class="tradingview-widget-container" style="height:46px;">
                <div class="tradingview-widget-container__widget"></div>
                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                {
                "symbols": [
                    { "proName": "FOREXCOM:XAUUSD", "title": "Gold Spot $" },
                    { "proName": "FOREXCOM:XAGUSD", "title": "Silber Spot $" },
                    { "proName": "TVC:PLATINUM", "title": "Platin Spot $" },
                    { "proName": "TVC:PALLADIUM", "title": "Palladium Spot $" }
                ],
                "colorTheme": "dark", "isTransparent": true, "displayMode": "compact", "locale": "de_DE"
                }
                </script>
            </div>
        </div>

        <main class="container" style="padding-top:20px; padding-bottom:50px;">

            <section id="dashboard" class="hidden-section" style="display:block;">
                <div class="grid-dashboard">
                    <aside class="sidebar" style="display:flex; flex-direction:column; gap:16px;">

                        <div class="card" style="border-left:4px solid var(--c-primary);">
                            <div class="source-badge"><i class="fa-solid fa-building-columns"></i> Händler Ankaufspreis (Referenz: Philoro)</div>
                            <div class="input-label" style="margin-top:6px">Gold 1 oz (Philharmoniker)</div>
                            <div class="big-price" id="dash-gold">...</div>
                            <div class="sub-price">abzüglich spread</div>
                        </div>

                        <div class="card" style="padding:12px;">
                            <div class="card-title" style="font-size:0.95rem; margin-bottom:8px;"><i class="fa-solid fa-coins"></i> Vergleich: 1 oz Münzen</div>
                            <div id="coin-compare" style="display:flex; flex-direction:column; gap:8px; font-size:0.95rem; color:var(--c-text-muted);"></div>
                        </div>

                        <div class="card" style="border-left:4px solid var(--color-silver);">
                            <div class="input-label">Silber 1 oz (Münze)</div>
                            <div class="big-price" id="dash-silver" style="color: var(--color-silver);">...</div>
                            <div class="sub-price">Differenzbesteuert</div>
                        </div>

                        <div class="grid-2">
                            <div class="card" style="padding:12px; border-left:4px solid var(--color-plat);">
                                <div class="input-label">Platin 1oz</div>
                                <div style="font-size:1.05rem; font-weight:700; color: var(--color-plat);" id="dash-plat">...</div>
                            </div>
                            <div class="card" style="padding:12px; border-left:4px solid var(--color-pall);">
                                <div class="input-label">Palladium 1oz</div>
                                <div style="font-size:1.05rem; font-weight:700; color: var(--color-pall);" id="dash-pall">...</div>
                            </div>
                        </div>

                        <div style="font-size:0.78rem; color:var(--c-text-muted); text-align:center;">
                            Preise aktualisiert am: <span id="update-date">...</span>
                        </div>

                    </aside>

                    <div class="main-content">
                        <div class="card" style="height:560px;">
                            <div class="card-header">
                                <div class="card-title"><i class="fa-solid fa-chart-area"></i> Spot Markt Entwicklung</div>
                            </div>
                            <div class="tradingview-widget-container" style="height:100%; width:100%;">
                                <div class="tradingview-widget-container__widget" style="height:100%;"></div>
                                <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
                                {
                                "symbols": [
                                    ["Gold", "FOREXCOM:XAUUSD|1D"],
                                    ["Silber", "FOREXCOM:XAGUSD|1D"],
                                    ["Platin", "TVC:PLATINUM|1D"],
                                    ["Palladium", "TVC:PALLADIUM|1D"]
                                ],
                                "chartOnly": false, "width": "100%", "height": "100%", "locale": "de_DE",
                                "colorTheme": "dark", "autosize": true, "showVolume": false, "hideDateRanges": false,
                                "scalePosition": "right", "backgroundColor": "#151e32"
                                }
                                </script>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="calculator" class="hidden-section">
                <div class="grid-dashboard" style="align-items:start">

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Bestand erweitern</div>
                            <button class="btn btn-outline btn-sm" onclick="clearPortfolio()">Reset</button>
                        </div>

                        <div class="calc-tabs" style="display:flex; gap:10px; margin-bottom:16px; background:transparent; padding:6px; border-radius:8px">
                            <div class="calc-tab btn btn-sm active" id="tab-cat" onclick="toggleCalcMode('catalog')" style="background:var(--c-bg-card); color:var(--c-primary);">Katalog Auswahl</div>
                            <div class="calc-tab btn btn-sm" id="tab-raw" onclick="toggleCalcMode('raw')">Manuell (Gramm)</div>
                        </div>

                        <div id="mode-catalog">
                            <label class="input-label">Metallart filtern</label>
                            <div style="display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap;">
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('all')">Alle</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('gold')" style="color:var(--color-gold); border-color:var(--color-gold);">Au</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('silver')" style="color:var(--color-silver); border-color:var(--color-silver);">Ag</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('platinum')" style="color:var(--color-plat); border-color:var(--color-plat);">Pt</button>
                                <button class="btn btn-sm btn-outline" onclick="filterCatalog('palladium')" style="color:var(--color-pall); border-color:var(--color-pall);">Pd</button>
                            </div>

                            <label class="input-label">Produkt wählen</label>

                            <!-- custom dropdown to avoid native large OS popup -->
                            <div class="select-wrapper">
                                <button id="catalogToggle" class="select-toggle" aria-haspopup="listbox" aria-expanded="false">Wähle ein Produkt <i class="fa-solid fa-caret-down"></i></button>
                                <ul id="catalogList" class="custom-select-list" role="listbox" aria-labelledby="catalogToggle" hidden></ul>
                                <!-- keep a hidden native select in sync so existing code can still query value if needed -->
                                <select id="catalogSelect" class="form-control visually-hidden" aria-hidden="true"></select>
                            </div>

                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <div style="flex:1;">
                                    <label class="input-label">Anzahl</label>
                                    <input type="number" id="cat-qty" class="form-control" value="1" min="1">
                                </div>
                                <div style="flex:1;">
                                    <label class="input-label">Einzelpreis (Est.)</label>
                                    <input type="text" id="cat-price-display" class="form-control" disabled style="opacity:0.95; color:var(--c-primary);">
                                </div>
                            </div>
                        </div>

                        <div id="mode-raw" style="display:none;">
                            <label class="input-label">Metall</label>
                            <select id="raw-metal" class="form-control select-inline">
                                <option value="gold">Gold</option>
                                <option value="silver">Silber</option>
                                <option value="platinum">Platin</option>
                                <option value="palladium">Palladium</option>
                            </select>
                            <label class="input-label">Gewicht (Gramm)</label>
                            <input type="number" id="raw-weight" class="form-control" placeholder="z.B. 31.1">
                            <label class="input-label">Feinheit</label>
                            <select id="raw-purity" class="form-control select-inline">
                                <option value="0.999">999 (Fein)</option>
                                <option value="0.916">916 (22k)</option>
                                <option value="0.750">750 (18k)</option>
                                <option value="0.585">585 (14k)</option>
                            </select>
                        </div>

                        <div style="margin-top:12px; border-top:1px solid var(--c-border); padding-top:14px; display:flex; gap:12px; align-items:center; justify-content:space-between;">
                            <div>
                                <div class="input-label">Bewertungs-Basis</div>
                                <div class="source-badge" style="background: rgba(255,255,255,0.02); border:1px solid rgba(197,160,89,0.08);">Händler-Ankauf (standard, ca. −5%)</div>
                            </div>
                            <button class="btn btn-primary" style="width:220px; margin-left:8px;" onclick="addToPortfolio()">Zur Liste hinzufügen</button>
                        </div>
                    </div>

                    <div class="card" style="display:flex; flex-direction:column;">
                        <div class="card-header">
                            <div class="card-title"><i class="fa-solid fa-vault"></i> Mein Portfolio</div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div id="port-count" style="font-size:0.9rem; color:var(--c-text-muted);">0 Positionen</div>
                                <button class="btn btn-outline btn-sm" onclick="exportPortfolioPDF()">Export PDF</button>
                            </div>
                        </div>

                        <div id="portfolio-container" style="flex-grow:1; margin-bottom: 20px; max-height:420px; overflow-y:auto;">
                            <p style="text-align:center; color: var(--c-text-muted); padding-top: 40px;">Noch keine Einträge.</p>
                        </div>

                        <div style="background: rgba(197, 160, 89, 0.08); padding: 14px; border-radius: var(--radius-md); border: 1px solid rgba(197, 160, 89, 0.12); text-align: right;">
                            <div class="sub-price">Gesamtwert Portfolio</div>
                            <div class="big-price" id="total-value">0,00 €</div>
                            <div class="sub-price" style="margin-top:6px; font-size:0.75rem;">Basierend auf hinterlegten Tagespreisen (Händler-Ankauf)</div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="analysis" class="hidden-section">
                <div class="card">
                    <div class="card-header"><div class="card-title">Marktkommentar & Analyse</div></div>
                    <p class="text-muted">Hier können manuelle Marktanalysen stehen...</p>
                </div>
            </section>

        </main>

        <footer>
            <div class="container" style="display:flex; flex-direction:column; gap:8px; align-items:center;">
                <div style="display:flex; gap:10px; align-items:center;"><i class="fa-solid fa-layer-group" style="color:var(--c-primary);"></i> Metallindex Group</div>
                <div style="max-width:1000px; text-align:center; color:var(--c-text-muted); font-size:0.9rem;">
                    &copy; 2025. Alle Rechte vorbehalten.<br>
                    Die angezeigten Preise sind indikative Händlerpreise basierend auf Tageswerten.
                </div>

                <div style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:6px;">
                    <button class="btn btn-outline btn-sm" onclick="openLegal('impressum')">Impressum</button>
                    <button class="btn btn-outline btn-sm" onclick="openLegal('haftung')">Haftungsausschluss</button>
                </div>
            </div>
        </footer>

        <!-- LEGAL MODALS -->
        <div id="legal-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:900; align-items:center; justify-content:center; padding:16px;">
            <div id="legal-modal" style="max-width:900px; width:100%; max-height:85vh; overflow:auto; background:var(--c-bg-card); border:1px solid var(--c-border); border-radius:12px; padding:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                    <h3 id="legal-title">Rechtliches</h3>
                    <button class="btn btn-outline" onclick="closeLegal()"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="legal-content" style="margin-top:12px; color:var(--c-text-muted); line-height:1.45;"></div>
            </div>
        </div>

    </div>

    <script>
        // =========================================================================
        // Anpassungen: Mobile Nav fix
        // - mobile-overlay + mobile-nav moved outside the nav to avoid stacking context issues
        // - overlay uses opacity & pointer-events; body scrolling disabled while open
        // - drawer width responsive (80vw / max 320px)
        // - keyboard accessible (Escape closes), clones nav items into drawer
        // - Passwortschutz entfernt (App zeigt sich direkt)
        // - native selects optisch an dunkles Theme angepasst (best-effort)
        // =========================================================================

        // <-- Minimal change: make these mutable (let) so we can overwrite them from prices.json -->
        let DAILY_SPOT_EUR = { gold: 3625, silver: 60, platinum: 1650, palladium: 1300 };
        let LAST_UPDATE = "31.12.2025, 08:30 Uhr";
        const PREMIUMS = { gold_coin: 1, gold_bar: 1, silver_coin: 1, silver_bar: 1, plat_coin: 1, pall_coin: 1 };
        const COIN_MODIFIERS = { 'g_phil_1': 1.00, 'g_krue_1': 0.97, 'g_maple_1': 0.99, 'g_brit_1': 1.01, 'g_eagle_1': 0.995, 'g_buff_1': 1.03, 'g_krue_05': 0.99 };
        const catalogDB = [ /* same as before */
            { id: 'g_krue_1', name: 'Krügerrand 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_krue_05', name: 'Krügerrand 1/2 oz', metal: 'gold', type: 'coin', fine: 15.552 },
            { id: 'g_maple_1', name: 'Maple Leaf 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_brit_1', name: 'Britannia 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_phil_1', name: 'Wiener Philharmoniker 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_eagle_1', name: 'American Eagle 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_buff_1', name: 'American Buffalo 1 oz', metal: 'gold', type: 'coin', fine: 31.103 },
            { id: 'g_vren', name: 'Vreneli 20 Fr', metal: 'gold', type: 'coin', fine: 5.806 },
            { id: 'g_dukat', name: '1 Dukat Österreich', metal: 'gold', type: 'coin', fine: 3.44 },
            { id: 'g_bar_100', name: 'Goldbarren 100g', metal: 'gold', type: 'bar', fine: 100.0 },
            { id: 'g_bar_50', name: 'Goldbarren 50g', metal: 'gold', type: 'bar', fine: 50.0 },
            { id: 'g_bar_1oz', name: 'Goldbarren 1 oz', metal: 'gold', type: 'bar', fine: 31.103 },
            { id: 'g_bar_10', name: 'Goldbarren 10g', metal: 'gold', type: 'bar', fine: 10.0 },
            { id: 's_maple', name: 'Silber Maple Leaf 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_krue', name: 'Silber Krügerrand 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_phil', name: 'Silber Philharmoniker 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_eagle', name: 'Silber Eagle 1 oz', metal: 'silver', type: 'coin', fine: 31.103 },
            { id: 's_bar_1kg', name: 'Silberbarren 1 kg', metal: 'silver', type: 'bar', fine: 1000.0 },
            { id: 's_bar_100', name: 'Silberbarren 100g', metal: 'silver', type: 'bar', fine: 100.0 },
            { id: 'pt_maple', name: 'Platin Maple Leaf 1 oz', metal: 'platinum', type: 'coin', fine: 31.103 },
            { id: 'pt_brit', name: 'Platin Britannia 1 oz', metal: 'platinum', type: 'coin', fine: 31.103 },
            { id: 'pt_bar_1', name: 'Platinbarren 1 oz', metal: 'platinum', type: 'bar', fine: 31.103 },
            { id: 'pd_maple', name: 'Palladium Maple Leaf 1 oz', metal: 'palladium', type: 'coin', fine: 31.103 },
            { id: 'pd_bar_1', name: 'Palladiumbarren 1 oz', metal: 'palladium', type: 'bar', fine: 31.103 }
        ];

        let portfolio = []; let lastAddedIndex = -1; const STANDARD_ANKAUF_SPREAD = 1
            ;

        /* ---------------------
           NEUE MINIMALE ERWEITERUNG:
           Lade ./prices.json (statisch) und überschreibe die
           Basis-Spotpreise (DAILY_SPOT_EUR) + LAST_UPDATE.
           Wenn das Laden fehlschlägt -> benutze die Fallback-Werte oben.
           --------------------- */
        async function loadPricesThenInit() {
            const PRICE_JSON_PATH = "./prices.json"; // relative Datei, z.B. von GitHub Pages docs/prices.json
            try {
                const resp = await fetch(PRICE_JSON_PATH, { cache: "no-store" });
                if (!resp.ok) throw new Error("prices.json nicht erreichbar: " + resp.status);
                const data = await resp.json();
                // Erwartete Struktur: { updated_at: "...", fetched_from: "...", rates: { gold: { per_oz: 3625.12 }, silver: {...}, ... } }
                if (data && data.rates) {
                    if (data.rates.gold && typeof data.rates.gold.per_oz === 'number') DAILY_SPOT_EUR.gold = data.rates.gold.per_oz;
                    if (data.rates.silver && typeof data.rates.silver.per_oz === 'number') DAILY_SPOT_EUR.silver = data.rates.silver.per_oz;
                    if (data.rates.platinum && typeof data.rates.platinum.per_oz === 'number') DAILY_SPOT_EUR.platinum = data.rates.platinum.per_oz;
                    if (data.rates.palladium && typeof data.rates.palladium.per_oz === 'number') DAILY_SPOT_EUR.palladium = data.rates.palladium.per_oz;
                    LAST_UPDATE = data.updated_at || data.fetched_from || new Date().toLocaleString('de-DE');
                    console.log('prices.json geladen — Spotpreise aktualisiert:', DAILY_SPOT_EUR);
                } else {
                    console.warn('prices.json geladen, aber Struktur ungültig. Verwende Fallbacks.');
                }
            } catch (err) {
                console.warn('Laden von prices.json fehlgeschlagen — benutze lokale Fallbacks:', err);
                LAST_UPDATE = "Fallback (offline) " + new Date().toLocaleString('de-DE');
            }

            // init UI wie bisher (keine Änderung)
            try {
                initCustomSelect(); populateCatalog('all'); renderPrices(); renderCoinComparison(); renderPortfolio(); buildMobileNav(); responsiveInit(); initMobileOverlay();
            } catch (e) {
                console.error('Fehler beim Initialisieren der UI:', e);
            }
            // show main content & update date label
            const main = document.getElementById('main-app'); if (main) main.style.display = 'block';
            const updEl = document.getElementById('update-date'); if (updEl) updEl.innerText = LAST_UPDATE;
        }

        window.onload = function () {
            // zuvor wurden hier direkt die Init-Funktionen aufgerufen.
            // Jetzt rufen wir zuerst loadPricesThenInit() auf, die die Preise lädt (falls vorhanden)
            // und danach die gleichen Init-Funktionen.
            loadPricesThenInit();
        };

        // removed checkPassword() and login overlay. App is directly visible.

        function switchView(viewId) { document.querySelectorAll('.hidden-section').forEach(el => el.style.display = 'none'); document.getElementById(viewId).style.display = 'block'; document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); if (viewId === 'dashboard') document.getElementById('nav-dash').classList.add('active'); if (viewId === 'calculator') document.getElementById('nav-calc').classList.add('active'); if (viewId === 'analysis') document.getElementById('nav-ana').classList.add('active'); closeMobileNav(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

        // MOBILE NAV: improved toggling + body-scroll lock
        function toggleMobileNav() {
            const mn = document.getElementById('mobile-nav'); const overlay = document.getElementById('mobile-overlay'); const btn = document.getElementById('hamburger'); const isOpen = mn.classList.contains('open');
            if (isOpen) closeMobileNav(); else {
                mn.classList.add('open'); overlay.classList.add('active'); overlay.setAttribute('aria-hidden', 'false'); btn.setAttribute('aria-expanded', 'true'); mn.setAttribute('aria-hidden', 'false'); document.body.classList.add('no-scroll'); // lock scroll
                // focus management: focus first link inside the drawer if exists
                setTimeout(() => { const first = mn.querySelector('.nav-item'); if (first) first.focus(); }, 220);
            }
        }
        function closeMobileNav() { const mn = document.getElementById('mobile-nav'); const overlay = document.getElementById('mobile-overlay'); const btn = document.getElementById('hamburger'); mn.classList.remove('open'); overlay.classList.remove('active'); overlay.setAttribute('aria-hidden', 'true'); btn.setAttribute('aria-expanded', 'false'); mn.setAttribute('aria-hidden', 'true'); document.body.classList.remove('no-scroll'); }
        function initMobileOverlay() { const overlay = document.getElementById('mobile-overlay'); overlay.addEventListener('click', closeMobileNav); document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMobileNav(); }); }

        function buildMobileNav() {
            const mn = document.getElementById('mobile-nav');
            // BUGFIX: select only the original nav menu items to avoid cloning clones
            const items = document.querySelectorAll('#navMenu .nav-item');
            mn.innerHTML = '';
            items.forEach(it => {
                const clone = it.cloneNode(true);
                // ensure cloned item is keyboard-focusable and will close drawer
                clone.tabIndex = 0;
                clone.onclick = function (ev) { ev.preventDefault(); it.onclick(); closeMobileNav(); };
                clone.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { it.onclick(); closeMobileNav(); } });
                clone.classList.remove('active');
                mn.appendChild(clone);
            });
        }

        // core functions unchanged (calculate, render etc.)
        function calculateItemPrice(item) { const spotPerOz = DAILY_SPOT_EUR[item.metal]; const spotPerGram = spotPerOz / 31.1034768; let premium = 1.0; if (item.metal === 'gold') premium = (item.type === 'coin') ? PREMIUMS.gold_coin : PREMIUMS.gold_bar; if (item.metal === 'silver') premium = (item.type === 'coin') ? PREMIUMS.silver_coin : PREMIUMS.silver_bar; if (item.metal === 'platinum') premium = PREMIUMS.plat_coin; if (item.metal === 'palladium') premium = PREMIUMS.pall_coin; const coinModifier = (item.type === 'coin' && COIN_MODIFIERS[item.id]) ? COIN_MODIFIERS[item.id] : 1.0; return item.fine * spotPerGram * premium * coinModifier; }
        function formatMoney(val) { return val.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }); }

        function renderPrices() { const phil = catalogDB.find(i => i.id === 'g_phil_1'); const philPrice = (phil) ? calculateItemPrice(phil) : (DAILY_SPOT_EUR.gold * PREMIUMS.gold_coin); document.getElementById('dash-gold').innerText = formatMoney(philPrice); const silver1 = catalogDB.find(i => i.id === 's_maple') || { metal: 'silver' }; const plat1 = catalogDB.find(i => i.id === 'pt_maple') || { metal: 'platinum' }; const pall1 = catalogDB.find(i => i.id === 'pd_maple') || { metal: 'palladium' }; document.getElementById('dash-silver').innerText = formatMoney(calculateItemPrice(silver1)); document.getElementById('dash-plat').innerText = formatMoney(calculateItemPrice(plat1)); document.getElementById('dash-pall').innerText = formatMoney(calculateItemPrice(pall1)); document.getElementById('update-date').innerText = LAST_UPDATE; }

        function renderCoinComparison() { const compareIds = ['g_phil_1', 'g_krue_1', 'g_maple_1', 'g_brit_1', 'g_eagle_1', 'g_buff_1']; const container = document.getElementById('coin-compare'); container.innerHTML = ''; compareIds.forEach(id => { const item = catalogDB.find(i => i.id === id); if (!item) return; const price = calculateItemPrice(item); const el = document.createElement('div'); el.style.display = 'flex'; el.style.justifyContent = 'space-between'; el.style.alignItems = 'center'; el.style.gap = '8px'; el.innerHTML = `<div style="font-weight:700; color:var(--c-text-main); font-size:0.95rem;">${item.name}</div><div style='text-align:right; font-size:0.95rem; color:var(--c-primary);'>${formatMoney(price)}</div>`; container.appendChild(el); }); }

        // CUSTOM SELECT IMPLEMENTATION
        function initCustomSelect() { const toggle = document.getElementById('catalogToggle'); const list = document.getElementById('catalogList'); const native = document.getElementById('catalogSelect'); toggle.addEventListener('click', (e) => { const open = list.hasAttribute('hidden'); if (open) { openCatalogList(); } else { closeCatalogList(); } }); document.addEventListener('click', (e) => { if (!e.target.closest('.select-wrapper')) closeCatalogList(); }); document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeCatalogList(); }); function openCatalogList() { list.hidden = false; list.removeAttribute('hidden'); toggle.setAttribute('aria-expanded', 'true'); list.focus(); } function closeCatalogList() { list.hidden = true; toggle.setAttribute('aria-expanded', 'false'); } }

        function populateCatalog(filter) { const sel = document.getElementById('catalogSelect'); const list = document.getElementById('catalogList'); sel.innerHTML = ''; list.innerHTML = ''; catalogDB.forEach(item => { if (filter === 'all' || item.metal === filter) { let opt = document.createElement('option'); opt.value = item.id; opt.text = item.name; sel.appendChild(opt); let li = document.createElement('li'); li.tabIndex = 0; li.setAttribute('role', 'option'); li.dataset.value = item.id; li.innerText = item.name; li.addEventListener('click', () => { selectCatalogItem(item.id); }); li.addEventListener('keydown', (e) => { if (e.key === 'Enter') selectCatalogItem(item.id); }); list.appendChild(li); } }); if (sel.options && sel.options.length > 0) { sel.selectedIndex = 0; selectCatalogItem(sel.options[0].value); } }

        function selectCatalogItem(id) { const sel = document.getElementById('catalogSelect'); const list = document.getElementById('catalogList'); const toggle = document.getElementById('catalogToggle'); sel.value = id; Array.from(list.children).forEach(li => { li.removeAttribute('aria-selected'); if (li.dataset.value === id) { li.setAttribute('aria-selected', 'true'); li.scrollIntoView({ block: 'nearest' }); } }); const item = catalogDB.find(x => x.id === id); toggle.innerHTML = `${item.name} <i class="fa-solid fa-caret-down"></i>`; updateCatDetails(); list.hidden = true; toggle.setAttribute('aria-expanded', 'false'); }

        function updateCatDetails() { const sel = document.getElementById('catalogSelect'); const id = sel.value || (sel.options[0] && sel.options[0].value); if (!id) return; const item = catalogDB.find(x => x.id === id); if (!item) return; const price = calculateItemPrice(item); document.getElementById('cat-price-display').value = formatMoney(price); }

        function toggleCalcMode(mode) { document.getElementById('mode-catalog').style.display = (mode === 'catalog') ? 'block' : 'none'; document.getElementById('mode-raw').style.display = (mode === 'raw') ? 'block' : 'none'; document.getElementById('tab-cat').classList.toggle('active', mode === 'catalog'); document.getElementById('tab-raw').classList.toggle('active', mode === 'raw'); }
        function filterCatalog(metalType) { populateCatalog(metalType); }

        function addToPortfolio() {
            let itemToAdd = {}; const spreadVal = STANDARD_ANKAUF_SPREAD; const catalogMode = document.getElementById('tab-cat').classList.contains('active'); if (catalogMode) { const id = document.getElementById('catalogSelect').value; const qty = parseInt(document.getElementById('cat-qty').value) || 1; const dbItem = catalogDB.find(x => x.id === id); if (!dbItem) return alert('Kein Produkt gewählt'); let basePrice = calculateItemPrice(dbItem); itemToAdd = { name: dbItem.name, metal: dbItem.metal, singleVal: basePrice, qty: qty, spread: spreadVal }; } else { const metal = document.getElementById('raw-metal').value; const weight = parseFloat(document.getElementById('raw-weight').value); const purity = parseFloat(document.getElementById('raw-purity').value); if (!weight || weight <= 0) return alert("Gewicht fehlt oder ungültig"); const spotPerOz = DAILY_SPOT_EUR[metal]; const spotPerGram = spotPerOz / 31.1034768; let basePrice = (weight * purity) * spotPerGram; itemToAdd = { name: `Manuell (${metal.toUpperCase()})`, metal: metal, singleVal: basePrice, qty: 1, spread: spreadVal }; }
            portfolio.push(itemToAdd); lastAddedIndex = portfolio.length - 1; renderPortfolio(); const addBtn = document.querySelector('.btn.btn-primary'); addBtn.style.transform = 'scale(0.98)'; setTimeout(() => addBtn.style.transform = '', 140);
        }

        function renderPortfolio() { const container = document.getElementById('portfolio-container'); let total = 0; if (portfolio.length === 0) { container.innerHTML = '<p style="text-align:center; color: var(--c-text-muted); padding-top: 40px;">Noch keine Positionen.</p>'; document.getElementById('total-value').innerText = formatMoney(0); document.getElementById('port-count').innerText = "0 Positionen"; return; } let html = '<div class="inventory-list">'; portfolio.forEach((item, index) => { const totalItemVal = item.singleVal * item.qty * item.spread; total += totalItemVal; let spreadLabel = ""; if (item.spread < 1.0 && item.spread > 0.8) spreadLabel = '<span style="font-size:0.7rem; color:var(--c-text-muted)">(Ankaufswert)</span>'; let iconColor = 'var(--c-text-main)'; if (item.metal === 'gold') iconColor = 'var(--color-gold)'; if (item.metal === 'silver') iconColor = 'var(--color-silver)'; if (item.metal === 'platinum') iconColor = 'var(--color-plat)'; if (item.metal === 'palladium') iconColor = 'var(--color-pall)'; html += `\n<div class="inventory-item" data-idx="${index}">\n  <div style="display:flex; align-items:center; gap:10px;">\n    <i class="fa-solid fa-circle" style="font-size:0.7rem; color:${iconColor};"></i>\n    <div>\n      <div style="font-weight:700; color:var(--c-text-main);">${item.name}</div>\n      <div style="font-size:0.82rem; color:var(--c-text-muted);">${item.qty} Stück ${spreadLabel}</div>\n    </div>\n  </div>\n  <div style="text-align:right;">\n    <div style="font-weight:700; color:var(--c-primary);">${formatMoney(totalItemVal)}</div>\n    <i class="fa-solid fa-trash" style="cursor:pointer; color:var(--c-text-muted); font-size:0.88rem; margin-top:6px;" onclick="removeFromPortfolio(${index})" aria-label="Position löschen"></i>\n  </div>\n</div>`; }); html += '</div>'; container.innerHTML = html; if (lastAddedIndex >= 0) { const itemEl = container.querySelector(`.inventory-item[data-idx='${lastAddedIndex}']`); if (itemEl) { itemEl.classList.add('item-added'); setTimeout(() => itemEl.classList.remove('item-added'), 600); } lastAddedIndex = -1; } document.getElementById('total-value').innerText = formatMoney(total); document.getElementById('port-count').innerText = portfolio.length + " Positionen"; }

        function removeFromPortfolio(idx) { portfolio.splice(idx, 1); renderPortfolio(); }
        function clearPortfolio() { portfolio = []; renderPortfolio(); }

        function responsiveInit() { buildMobileNav(); function adjustCharts() { const tvs = document.querySelectorAll('.tradingview-widget-container'); tvs.forEach(el => { if (window.innerWidth < 700) el.style.minHeight = '220px'; else if (window.innerWidth < 1100) el.style.minHeight = '360px'; else el.style.minHeight = '540px'; }); } adjustCharts(); window.addEventListener('resize', adjustCharts); }

        // LEGAL modal
        function openLegal(type) { const overlay = document.getElementById('legal-overlay'); const title = document.getElementById('legal-title'); const content = document.getElementById('legal-content'); overlay.style.display = 'flex'; if (type === 'impressum') { title.innerText = 'Impressum'; content.innerHTML = `<strong>Metallindex Group</strong><br>Österreich<br>Marchegg<br>Telefon: -------------- <br>E-Mail: business.metallindex@gmail.com<br>Betreiber: Tobias T.`; } else { title.innerText = 'Haftungsausschluss'; content.innerHTML = `<strong>Haftungsausschluss / Disclaimer</strong><br><br>Die Informationen auf dieser Webseite dienen ausschließlich Informationszwecken und stellen weder ein Angebot noch eine Anlageberatung dar. Trotz sorgfältiger inhaltlicher Kontrolle übernehmen wir keine Gewähr für die Aktualität, Richtigkeit, Vollständigkeit oder Qualität der bereitgestellten Informationen. <br><br>Insbesondere sind die dargestellten Preise indikativ und können Abweichungen gegenüber konkreten Händlerspreisen aufweisen. Entscheidungen, die Sie auf Grundlage der Inhalte dieser Seite treffen, liegen in Ihrer Verantwortung. Wir haften nicht für unmittelbare oder mittelbare Schäden, die aus der Nutzung dieser Informationen entstehen.`; } }
        function closeLegal() { document.getElementById('legal-overlay').style.display = 'none'; }

        // =========================================================================
        // PDF Export: professional, text-based export using jsPDF
        // requires jspdf (loaded below). The export uses the same formatMoney helper.
        // =========================================================================
        function exportPortfolioPDF() {
            if (!portfolio || portfolio.length === 0) { alert('Das Portfolio ist leer. Bitte fügen Sie zuerst Positionen hinzu.'); return; }
            if (!window.jspdf) { alert('PDF-Export: Bibliothek nicht geladen. Bitte prüfen Sie die Verbindung.'); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });
            const margin = 15;
            let y = 20;
            doc.setFontSize(14);
            doc.text('Metallindex – Portfolio', margin, y);
            doc.setFontSize(10);
            y += 6;
            doc.text('Exportdatum: ' + new Date().toLocaleString('de-DE'), margin, y);
            y += 8;

            // header row
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Pos.', margin, y);
            doc.text('Bezeichnung', margin + 12, y);
            doc.text('Anz.', margin + 98, y);
            doc.text('Einzel', margin + 120, y);
            doc.text('Gesamt', margin + 160, y);
            y += 4;
            doc.setDrawColor(200);
            doc.setLineWidth(0.3);
            doc.line(margin, y, 195, y);
            y += 6;

            doc.setFont(undefined, 'normal');
            const lineHeight = 7;
            portfolio.forEach((item, idx) => {
                const totalItemVal = item.singleVal * item.qty * item.spread;
                const name = item.name;
                const qtyStr = String(item.qty);
                const singleStr = formatMoney(item.singleVal);
                const totalStr = formatMoney(totalItemVal);

                const maxWidthName = 80; // mm
                const splitName = doc.splitTextToSize(name, maxWidthName);
                const lines = Math.max(splitName.length, 1);

                for (let i = 0; i < lines; i++) {
                    if (y > 275) { doc.addPage(); y = 20; }
                    if (i === 0) {
                        doc.text(String(idx + 1), margin, y);
                        doc.text(splitName[i], margin + 12, y);
                        doc.text(qtyStr, margin + 98, y);
                        doc.text(singleStr, margin + 120, y);
                        doc.text(totalStr, margin + 160, y);
                    } else {
                        doc.text(splitName[i], margin + 12, y);
                    }
                    y += lineHeight;
                }
            });

            if (y > 260) { doc.addPage(); y = 20; }
            y += 4;
            doc.setLineWidth(0.4);
            doc.line(margin, y, 195, y);
            y += 8;
            doc.setFont(undefined, 'bold');
            const totalValueText = document.getElementById('total-value').innerText || formatMoney(0);
            doc.text('Gesamtwert: ' + totalValueText, margin, y);

            const filename = 'Metallindex_Portfolio_' + (new Date()).toISOString().slice(0, 10) + '.pdf';
            doc.save(filename);
        }

    </script>

    <!-- jspdf (UMD) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
